<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QR SafeShare - Samenvoegen</title>
  <link rel="stylesheet" href="lib/tailwind.min.css">
  <script src="lib/secrets.min.js"></script>
  <script src="lib/html5-qrcode.min.js"></script>
  <script src="lib/jsqr.min.js"></script> <!-- lokaal gehost -->
  <style>
  @keyframes highlight {
    0%   { box-shadow: 0 0 0px 0 rgba(16,185,129,0.8); }
    50%  { box-shadow: 0 0 20px 6px rgba(16,185,129,0.8); }
    100% { box-shadow: 0 0 0px 0 rgba(16,185,129,0.0); }
  }
  .highlight-anim {
    animation: highlight 1.5s ease-out;
  }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

<div class="max-w-3xl mx-auto p-4 space-y-4">

<!-- Kleine header met logo -->
<header class="text-center mb-4">
  <a href="https://qr.area404.nl/" class="inline-block hover:opacity-80">
    <img src="logo.svg" alt="QR SafeShare logo" class="w-16 h-16 mx-auto">
  </a>
</header>

  <!-- Scanner -->
  <section class="bg-white rounded-xl shadow p-4 space-y-3">
    <h2 class="text-lg font-semibold">Stap 1: Scan QR-codes</h2>
    <select id="cameraSelect" class="hidden border rounded p-2 w-full"></select>
    <div id="reader" class="w-full aspect-square rounded-lg overflow-hidden border"></div>

    <!-- Upload QR -->
    <div class="mt-3">
      <label for="fileInput" class="block text-sm font-medium text-gray-700">Of kies een QR-afbeelding</label>
      <input type="file" id="fileInput" accept="image/*" class="mt-1 w-full text-sm border rounded p-2">
    </div>
  </section>

  <!-- Status melding -->
  <div id="statusBox" class="hidden text-center text-base font-semibold p-2 rounded-lg shadow-sm"></div>

  <!-- Resultaat -->
  <section id="resultSection" class="bg-white rounded-xl shadow p-4 space-y-3">
    <h2 class="text-lg font-semibold">Stap 2: Resultaat</h2>
    <textarea id="resultSecret" rows="2" class="w-full border rounded p-3 text-base text-center" readonly placeholder="(wachtwoord verschijnt hier)"></textarea>
    <div class="flex gap-2">
      <button id="btnCopy" class="flex-1 bg-teal-600 text-white rounded px-4 py-2 text-base">Kopieer</button>
      <button id="btnReset" class="flex-1 bg-gray-500 text-white rounded px-4 py-2 text-base">Opnieuw</button>
    </div>

    <!-- Buy Me a Coffee blok (verstopt tot succes) -->
    <div id="bmac-block" style="display:none; text-align:center; margin-top:20px;">
      <p class="text-gray-700 text-base mb-2">
        ‚òï Vind je QR SafeShare handig?<br>
        Steun het project met een kop koffie:
      </p>
      <a href="https://buymeacoffee.com/qrsafeshare" target="_blank" rel="noopener">
        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" 
             alt="Buy Me a Coffee" class="mx-auto" style="height: 45px;">
      </a>
    </div>
  </section>

  <footer class="text-xs text-gray-500 text-center">
    <p>Alles blijft lokaal in je browser. Er wordt niets ge√ºpload.</p>
  </footer>

</div>

<script>
const $ = sel => document.querySelector(sel);

function bytesToStr(b){return new TextDecoder().decode(b)}
function hexToBytes(hex){const out=new Uint8Array(hex.length/2);for(let i=0;i<out.length;i++)out[i]=parseInt(hex.substr(i*2,2),16);return out}
function b64uToBytes(str){
  let b64=str.replace(/-/g,'+').replace(/_/g,'/');
  while(b64.length%4)b64+='=';
  const bin=atob(b64);
  const out=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++)out[i]=bin.charCodeAt(i);
  return out;
}
function parseMaybeJson(txt){ try{ return JSON.parse(txt); }catch(_){ return txt; } }

let scannedInputs = [];

function addPayload(txt){
  try {
    const obj = JSON.parse(txt);
    if(obj && obj.id && obj.idx){
      const already = scannedInputs.some(p=>{
        try{
          const q=JSON.parse(p);
          return q.id===obj.id && q.idx===obj.idx;
        }catch{ return false; }
      });
      if(already) return false;
    } else {
      if(scannedInputs.includes(txt)) return false;
    }
    scannedInputs.push(txt);
    return true;
  } catch {
    if(scannedInputs.includes(txt)) return false;
    scannedInputs.push(txt);
    return true;
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  if(location.hash.length > 1){
    try {
      const payload = decodeURIComponent(location.hash.slice(1));
      if(addPayload(payload)){
        showStatus("‚ÑπÔ∏è Extra QR-deel al geladen via link", "info");
        autoCombine();
      }
    } catch(e){
      console.error("Kon payload uit link niet laden:", e);
    }
  }
});

function showStatus(msg, type){
  const box = $('#statusBox');
  box.textContent = msg;
  box.className = "text-center text-base font-semibold p-2 rounded-lg shadow-sm";
  if(type==="success"){ box.classList.add("bg-green-600","text-white"); }
  else if(type==="error"){ box.classList.add("bg-red-600","text-white"); }
  else if(type==="info"){ box.classList.add("bg-yellow-300","text-black"); }
  else { box.classList.add("bg-gray-300","text-black"); }
  box.classList.remove("hidden");
}

function tryXor(inputs){
  const env = inputs.map(parseMaybeJson);
  if(!env.every(e => typeof e === 'object' && e && e.t==='xor-qr')) return null;
  const ids = new Set(env.map(e=>e.id)); 
  if(ids.size!==1) throw new Error('Deze QR-codes horen niet bij elkaar.');
  if(env.length !== 2) return null;
  const [A,B] = env;
  const R = b64uToBytes(A.data); 
  const X = b64uToBytes(B.data);
  if(R.length !== X.length) throw new Error('Deze QR-codes passen niet samen.');
  const S = new Uint8Array(R.length); 
  for(let i=0;i<S.length;i++) S[i] = R[i] ^ X[i];
  return bytesToStr(S);
}

function tryShamir(inputs){
  const env = inputs.map(parseMaybeJson);
  const shares = [];
  let id = null, k = null;
  for(const e of env){
    if(e && e.t==='sss-qr'){
      if(id===null) id=e.id; else if(id!==e.id) throw new Error('Deze QR-codes horen niet bij dezelfde set.');
      if(k===null) k=e.k;
      shares.push(e.share);
    }
  }
  if(!k) return null;
  if(shares.length < k) return null;
  secrets.init(8);
  const hex = secrets.combine(shares);
  return bytesToStr(hexToBytes(hex));
}

function autoCombine(){
  let result = null, err = '';
  try{ result = tryXor(scannedInputs); }catch(e){ err = e?.message||String(e); }
  if(result===null){
    try{ result = tryShamir(scannedInputs); }catch(e){ err = e?.message||String(e); }
  }

  const resultBox = $('#resultSection');

  if(result){
    $('#resultSecret').value = result;
    showStatus("‚úÖ Wachtwoord hersteld!", "success");
    resultBox.classList.remove("bg-white","border-gray-200");
    resultBox.classList.add("bg-green-50","border","border-green-300");

    // ‚úÖ Toon Buy Me a Coffee-blok
    $('#bmac-block').style.display = "block";

    // üîΩ Scroll automatisch naar resultaat
    resultBox.scrollIntoView({ behavior: "smooth" });

    // ‚ú® Highlight-animatie
    resultBox.classList.add("highlight-anim");
    setTimeout(()=> resultBox.classList.remove("highlight-anim"), 1600);

  } else if(err){
    $('#resultSecret').value = "";
    showStatus("‚ùå " + err, "error");
    resultBox.classList.remove("bg-green-50","border-green-300");
    resultBox.classList.add("bg-white");
    $('#bmac-block').style.display = "none";
  } else {
    let needed = 2;
    for(const e of scannedInputs.map(parseMaybeJson)){
      if(e && e.t==="sss-qr"){ needed = e.k; break; }
    }
    const scanned = scannedInputs.length;
    if(scanned < needed){
      if(location.hash.length > 1 && scanned === 1){
        showStatus("‚è≥ Wachten op QR-code", "info");
      } else {
        showStatus(`‚è≥ QR ${scanned}/${needed} gescand`, "info");
      }
      resultBox.classList.remove("bg-green-50","border-green-300");
      resultBox.classList.add("bg-white");
      $('#bmac-block').style.display = "none";
    }
  }
}

async function startScanner(){
  if(!window.Html5Qrcode){ alert("html5-qrcode ontbreekt"); return; }
  const scanner = new Html5Qrcode("reader");
  try {
    const devices = await Html5Qrcode.getCameras();
    if(devices.length > 1){
      const sel = $('#cameraSelect');
      sel.classList.remove("hidden");
      sel.innerHTML = devices.map(d=>`<option value="${d.id}">${d.label}</option>`).join("");
      sel.addEventListener("change", ()=> {
        scanner.stop().then(()=>scanner.start(sel.value,{fps:10,qrbox:250}, onScan));
      });
    }
    let camId = devices.find(d => d.label.toLowerCase().includes("back"))?.id || devices[0].id;
    await scanner.start(camId, { fps:10, qrbox:250 }, onScan);

    const sel = $('#cameraSelect');
    if(sel && devices.length > 1){
      sel.value = camId;
    }
  } catch(e){
    alert("Kon camera niet starten: " + (e?.message||e));
  }

  function onScan(txt){
    if(addPayload(txt)){
      autoCombine();
    }
  }

  $('#btnReset').addEventListener('click', ()=>{
    scannedInputs = [];
    $('#resultSecret').value = "";
    showStatus("‚è≥ Scan opnieuw een QR-code", "info");
    const resultBox = $('#resultSection');
    resultBox.classList.remove("bg-green-50","border-green-300");
    resultBox.classList.add("bg-white");
    $('#bmac-block').style.display = "none";
  });
}

startScanner();

// Kopieer knop
$('#btnCopy').addEventListener('click', async ()=>{
  const v = $('#resultSecret').value; 
  if(!v) return;
  try{ 
    await navigator.clipboard.writeText(v); 
    alert("Wachtwoord gekopieerd!");
  }catch(_){}
});

// Upload QR-afbeelding
$('#fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = (ev)=>{
    const img = new Image();
    img.onload = ()=>{
      const MAX_SIZE = 800;
      let scale = Math.min(MAX_SIZE / img.width, MAX_SIZE / img.height, 1);
      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,canvas.width,canvas.height);

      const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if(code){
        if(addPayload(code.data)){
          autoCombine();
          showStatus("üì∑ QR-afbeelding succesvol geladen", "success");
        }
      } else {
        showStatus("‚ùå Geen QR-code gevonden in afbeelding", "error");
      }
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});
</script>

</body>
</html>
