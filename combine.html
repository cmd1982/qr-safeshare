<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>QR SafeShare - Samenvoegen</title>
<link href="favicon.ico" rel="icon" type="image/x-icon"/>
<link href="apple-touch-icon.png" rel="apple-touch-icon"/>
<link href="lib/tailwind.min.css" rel="stylesheet"/>
<script src="lib/secrets.min.js"></script>
<style>
    /* Scanner sizing fix for desktop browsers */
    #reader {
      position: relative;
      max-width: 640px;
      height: 320px;
      margin: 0 auto;
      overflow: hidden; /* prevent video from overlapping following sections */
    }
    /* Ensure the injected video/canvas by html5-qrcode fits inside the box */
    #reader video,
    #reader__scan_region video,
    #reader canvas,
    #reader__scan_region canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      border-radius: 0.75rem;
      display: block;
    }
    #reader__scan_region { height: 100% !important; }
    @media (max-width: 640px){
      #reader { height: 260px; }
    }
  </style>
<script>
try{
  var chosen = localStorage.getItem('qrs_lang');
  if (chosen === 'en') {
    var p = location.pathname || '';
    if (!/combine-en\.html$/.test(p)) location.replace('combine-en.html');
  } else {
    localStorage.setItem('qrs_lang','nl');
  }
}catch(e){}</script>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
<div class="max-w-5xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <header class="mb-6 text-center flex flex-col items-center gap-2">
    <a class="flex flex-col items-center hover:opacity-80" href="index.html">
      <img alt="QR SafeShare logo" class="w-16 h-16" src="logo.svg"/>
      <span class="text-3xl font-bold text-teal-700">QR SafeShare</span>
    </a>
    <p class="text-gray-600">Geheimen samenvoegen uit QR-codes</p>
    <div class="text-sm"><span class="font-semibold">NL</span><span class="mx-1 text-gray-400"> | </span><a class="underline text-teal-700" href="combine-en.html" onclick="try{localStorage.setItem('qrs_lang','en')}catch(e){}">EN</a></div>
  </header>

  <!-- Scanner + upload -->
  <section class="bg-white rounded-xl shadow p-6 space-y-4">
    <div class="w-full h-64 border rounded" id="reader"></div>
    <input accept="image/*" class="mt-3 block w-full border rounded p-2" id="fileInput" type="file"/>
  </section>

  <!-- Gevonden delen -->
  <section class="bg-white rounded-xl shadow p-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Gescande delen</h2>
      <button id="resetBtnTop" class="bg-gray-300 text-gray-800 rounded px-3 py-2">Reset</button>
    </div>

    <!-- Nieuw: progress-indicator -->
    <div id="progressIndicator" class="text-sm font-medium text-gray-700 mb-2">
      Nog geen QR-codes gescand.
    </div>

    <div class="space-y-2" id="foundShares"></div>
  </section>

  <!-- Resultaat -->
  <section class="bg-white rounded-xl shadow p-6 hidden" id="resultaat">
    <h2 class="text-lg font-semibold mb-3">Hersteld geheim</h2>
    <div id="secretContainer"></div>
    <div class="flex gap-2 mt-3">
      <button class="flex-1 bg-teal-600 text-white rounded px-3 py-2" id="copyBtn">Kopieer</button>
      <button class="flex-1 bg-gray-300 text-gray-800 rounded px-3 py-2" id="resetBtn">Reset</button>
    </div>
    <!-- Buy Me a Coffee -->
    <div id="bmac-block" style="display:none; text-align:center; margin-top:20px;">
      <p class="text-gray-700 text-base mb-2">
        â˜• Vind je QR SafeShare handig?<br/>
        Steun het project met een kop koffie:
      </p>
      <a href="https://buymeacoffee.com/qrsafeshare" rel="noopener" target="_blank">
        <img alt="Buy Me a Coffee" class="mx-auto" src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" style="height: 45px;"/>
      </a>
    </div>
  </section>
</div>

<!-- Duidelijkere beep (~500 Hz, 300 ms) via <audio> -->
<audio id="beepSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAgP///wDwPwAA8D8AAPB/AADwfwAA8H8AAPB/AADwfwAA8H8AAPB/AADwfwAA8H8AAPB/AADwPwAA" type="audio/wav"/>
</audio>

<script src="lib/html5-qrcode.min.js"></script>
<script src="lib/jsqr.min.js"></script>
<script>
// --- Audio unlock + feedback (beep + vibratie) ---
(function(){
  function unlock(){
    const b=document.getElementById('beepSound');
    if(!b) return;
    const handler=()=>{
      b.muted=true;
      const pr=b.play();
      if(pr && pr.then){
        pr.then(()=>{ b.pause(); b.muted=false; b.currentTime=0; });
      } else {
        try{ b.pause(); b.muted=false; b.currentTime=0; }catch(e){}
      }
      window.removeEventListener('touchstart', handler, true);
      window.removeEventListener('click', handler, true);
      window.removeEventListener('keydown', handler, true);
    };
    window.addEventListener('touchstart', handler, true);
    window.addEventListener('click', handler, true);
    window.addEventListener('keydown', handler, true);
  }
  if(document.readyState==='complete' || document.readyState==='interactive'){
    unlock();
  } else {
    window.addEventListener('DOMContentLoaded', unlock);
  }
})();

function feedbackSuccess(){
  const beep=document.getElementById("beepSound");
  if(beep){
    const snd = beep.cloneNode(true);
    snd.style.display='none';
    document.body.appendChild(snd);
    try{ snd.currentTime=0; }catch(e){}
    snd.play().catch(()=>{});
    snd.addEventListener('ended', ()=>{ snd.remove(); });
  }
  if(navigator.vibrate){
    navigator.vibrate(150);
  }
}

// Opslag voor ontvangen shares
let shares = [];
let secretCategory = null;

// Nieuw: voortgang bijwerken
function updateProgress() {
  const prog = document.querySelector("#progressIndicator");
  if (!prog) return;

  if (shares.length === 0) {
    prog.textContent = "Nog geen QR-codes gescand.";
    prog.className = "text-sm font-medium text-gray-700 mb-2";
    return;
  }

  const totaal = shares[0]?.t === "s" ? shares[0].k : 2; // Shamir k nodig, XOR altijd 2
  const huidig = shares.length;
  const resterend = Math.max(0, totaal - huidig);

  if (resterend > 0) {
    prog.textContent = `Gescand: ${huidig}/${totaal} (nog ${resterend} te gaan)`;
    prog.className = "text-sm font-medium text-orange-600 mb-2";
  } else {
    prog.textContent = `Alle benodigde QR-codes gescand (${huidig}/${totaal}) ðŸŽ‰`;
    prog.className = "text-sm font-medium text-green-700 mb-2";
  }
}

// Popup statusmeldingen
function showStatus(msg, type="info"){
  const old = document.querySelector(".popupStatus");
  if(old) old.remove();

  const div=document.createElement('div');
  div.textContent=msg;
  div.className='popupStatus fixed bottom-4 left-1/2 -translate-x-1/2 text-sm px-3 py-2 rounded-xl shadow z-50';
  
  if(type==="success"){ div.classList.add('bg-green-600','text-white'); }
  else if(type==="error"){ div.classList.add('bg-red-600','text-white'); }
  else { div.classList.add('bg-gray-900','text-white'); }

  document.body.appendChild(div);
  setTimeout(()=>div.remove(),2500);
}

// Payload verwerken
function handleScannedPayload(text){
  try {
    const clean = text.trim();
    const env = JSON.parse(clean);

    // Duplicaat â†’ stil negeren
    if (shares.some(s => s.id === env.id && s.i === env.i)) {
      return;
    }

    
    // --- Validate that incoming share belongs to the same set ---
    if (shares.length > 0) {
      const cur = shares[0];
      if (env.id !== cur.id) {
        const msg = `Deze QR hoort bij een andere set (id ${env.id}). Huidige set: ${cur.id}.`;
        showStatus(msg, "error");
        return;
      }
      if (env.t !== cur.t) {
        const msg = `QR-type komt niet overeen met de huidige set.`;
        showStatus(msg, "error");
        return;
      }
      if (env.t === 's') {
        const k0 = Number(cur.k || 0);
        const k1 = Number(env.k || 0);
        if (k0 && k1 && k0 !== k1) {
          const msg = ``+`Drempel (k) verschilt: ontvangen ${k1}, huidig ${k0}.`;
          showStatus(msg, "error");
          return;
        }
      }
    }
shares.push(env);

    // Nieuw: voortgang bijwerken na toevoegen
    updateProgress();

    // Bewaar categorie (password/crypto/note) indien aanwezig
    if(env.c){ secretCategory = env.c; }

    const div=document.createElement('div');
    div.textContent = `Deel ${env.i} ontvangen (id ${env.id})`;
    div.className="p-2 border rounded bg-gray-100 text-sm";
    document.querySelector("#foundShares").appendChild(div);

    showStatus(`QR gescand: deel ${env.i} ontvangen`,"success");
    feedbackSuccess();

    tryRestore();
  } catch(e){
    console.error("Geen geldige payload", e);
    const t = String(text||"").trim();
    // Alleen melden als het *wel* JSON lijkt maar alsnog niet parsebaar is
    if (t.startsWith("{")) {
      showStatus("Geen geldige QR-code","error");
    }
    // Anders stil negeren (kan afkomstig zijn van willekeurige QR in camera of binaire data)
  }
}

// Geheim herstellen
function tryRestore(){
  if(shares.length < 2) return;

  const type = shares[0].t;

  if(type === 'x'){ // XOR
    if(shares.length >= 2){
      const R = Uint8Array.from(atob(shares[0].d.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0));
      const B = Uint8Array.from(atob(shares[1].d.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0));
      if (R.length !== B.length) { showStatus('Grootte van XOR-delen komt niet overeen', 'error'); return; }
      const S = new Uint8Array(R.length);
      for(let i=0;i<R.length;i++) S[i]=R[i]^B[i];
      showSecret(new TextDecoder().decode(S));
    }
  }
  if(type === 's'){ // Shamir
    if(shares.length >= shares[0].k){
      const parts = shares.map(s=>s.d);
      const secretHex = secrets.combine(parts);
      const bytes = new Uint8Array(secretHex.match(/.{1,2}/g).map(b=>parseInt(b,16)));
      showSecret(new TextDecoder().decode(bytes));
    }
  }
}

// Geheim tonen
function showSecret(txt){
  const cont=document.querySelector("#secretContainer");
  cont.innerHTML="";

  if(secretCategory === 'crypto'){
    const words = txt.trim().split(/\s+/).filter(Boolean);
    const ol=document.createElement("ol");
    ol.className="list-decimal list-inside space-y-1 text-sm";
    words.forEach(w=>{
      const li=document.createElement("li");
      li.textContent=w;
      ol.appendChild(li);
    });
    cont.appendChild(ol);
  } else {
    const ta=document.createElement("textarea");
    ta.rows=6;
    ta.className="w-full border rounded p-2 font-mono";
    ta.value=txt;
    cont.appendChild(ta);
  }

  document.querySelector("#resultaat").classList.remove("hidden");
  document.querySelector("#bmac-block").style.display="block";
  setTimeout(()=>{ cont.scrollIntoView({behavior:"smooth"}); },300);

  showStatus("âœ… Geheim hersteld!","success");
  feedbackSuccess();
}

// Kopieer & reset
document.querySelector("#copyBtn").addEventListener("click", async ()=>{
  const ta=document.querySelector("#secretContainer textarea");
  let textToCopy="";
  if(ta){ textToCopy=ta.value; }
  else {
    textToCopy=[...document.querySelectorAll("#secretContainer li")].map(li=>li.textContent).join(" ");
  }
  try {
    await navigator.clipboard.writeText(textToCopy);
    showStatus("Geheim gekopieerd","success");
    feedbackSuccess();
  } catch {}
});
function doReset(){
shares=[];
  updateProgress(); // Nieuw: voortgang resetten
  document.querySelector("#foundShares").innerHTML="";
  document.querySelector("#resultaat").classList.add("hidden");
  document.querySelector("#bmac-block").style.display="none";
  showStatus("Reset voltooid","info");
}
document.querySelector("#resetBtn").addEventListener("click", doReset);
const resetBtnTop = document.querySelector("#resetBtnTop");
if (resetBtnTop) resetBtnTop.addEventListener("click", doReset);
// QR scanner starten (responsive qrbox + fixed aspect ratio to avoid oversized video)
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const qrbox = (vw, vh) => {
  const size = Math.floor(Math.min(vw, vh) * (isMobile ? 0.70 : 0.60));
  return { width: size, height: size };
};
const qr = new Html5Qrcode("reader");
const cameraConstraints = { facingMode: "environment" };
const cameraConfig = { fps: 10, qrbox, aspectRatio: 1.333 };
qr.start(cameraConstraints, cameraConfig, handleScannedPayload);

// Unified upload handler (image+text) met jsQR fallback
document.querySelector("#fileInput").addEventListener("change", async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const name = (file.name || "").toLowerCase();
  const mime = (file.type || "");
  const looksImage = (mime.startsWith("image/")) || /\.(png|jpe?g|gif|bmp|webp)$/.test(name);

  try {
    if (looksImage) {
      let decodedText = null;
      // 1) html5-qrcode scanFile (requires no ongoing camera scan)
      if (typeof qr.scanFile === "function") {
        try {
          await qr.stop().catch(()=>{});
          decodedText = await qr.scanFile(file, true);
        } catch(_e){ decodedText = null; }
        finally {
          // restart camera for live scanning again
          try { await qr.start(cameraConstraints, cameraConfig, handleScannedPayload); } catch(_e){}
        }
      }
      // 2) jsQR fallback
      if (!decodedText && (typeof jsQR === "function")) {
        decodedText = await (async function decodeWithJsQR(f){
          const fr = new FileReader();
          const url = await new Promise((res, rej)=>{ fr.onerror=()=>rej(new Error("read error")); fr.onload=()=>res(String(fr.result||"")); fr.readAsDataURL(f); });
          await new Promise((resolve, reject)=>{
            const img = new Image();
            img.onload = ()=>resolve();
            img.onerror = ()=>reject(new Error("img load error"));
            img.src = url;
          });
          const canvas = document.createElement("canvas");
          const imgEl = new Image(); imgEl.src = url; await imgEl.decode();
          canvas.width = imgEl.width; canvas.height = imgEl.height;
          const ctx = canvas.getContext("2d", { willReadFrequently: true });
          ctx.drawImage(imgEl, 0, 0);
          const { data, width, height } = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const res = jsQR(data, width, height);
          if (res && res.data) return res.data;
          return null;
        })(file);
      }
      if (decodedText) {
        const clean = String(decodedText||"").trim();
        try { handleScannedPayload(decodeURIComponent(clean)); } catch { handleScannedPayload(clean); }
        return;
      } else {
        showStatus("Geen QR gevonden in afbeelding. Upload de payload-tekst uit split.html.","error");
        return;
      }
    }

    // TEXT path
    const reader = new FileReader();
    reader.onload = () => {
      const txt = String(reader.result || "").trim();
      handleScannedPayload(txt);
    };
    reader.readAsText(file);

  } catch(err){
    console.error(err);
    showStatus("Upload-fout: "+err, "error");
  } finally {
    // clear selected file so the same file kan gekozen
    e.target.value = "";
  }
});

// Hash auto-loader
window.addEventListener("load", ()=>{
  if(location.hash.length > 1){
    try {
      const payload = decodeURIComponent(location.hash.substring(1));
      location.hash = ""; // schoonmaken
      handleScannedPayload(payload);
    } catch(e){
      showStatus("Kon hash niet verwerken","error");
    }
  }
});
</script>
<script>try{localStorage.setItem('qrs_lang','nl')}catch(e){}</script>
</body>
</html>
